# 众筹智能合约需求设计文档

## 1. 项目概述

### 1.1 项目背景
随着区块链技术的发展，去中心化众筹平台能够提供更透明、可信的资金管理方式。本项目旨在利用Solana区块链和Anchor框架构建一个功能完整的去中心化众筹平台，解决传统众筹平台中的信任问题和资金管理不透明问题。

### 1.2 项目目标
- 提供去中心化的众筹解决方案
- 确保资金管理的透明性和安全性
- 实现智能化的资金分配和退款机制
- 优化存储成本，提供完整的账户生命周期管理

### 1.3 核心价值主张
- **透明度**：所有交易记录在区块链上公开可查
- **安全性**：资金由智能合约管理，避免中心化风险
- **自动化**：自动执行资金分配和退款
- **成本效益**：优化的租金管理降低用户成本

## 2. 功能需求

### 2.1 众筹项目管理
#### 2.1.1 创建众筹项目
- **功能描述**：用户可创建新的众筹项目
- **输入参数**：
  - 项目名称（最大128字符）
  - 项目描述（最大1024字符）
  - 项目分类（最大64字符）
  - 标签列表（最多10个标签，每个最大32字符）
  - 目标金额（lamports）
  - 结束时间（Unix时间戳）
- **业务规则**：
  - 自动存入租金免除金额
  - 初始状态为"未开始"
  - 记录项目创建者为所有者

#### 2.1.2 更新项目信息
- **功能描述**：项目所有者可更新项目信息
- **前置条件**：项目状态为"未开始"
- **权限控制**：仅项目所有者可操作

#### 2.1.3 开始众筹
- **功能描述**：启动众筹项目
- **前置条件**：项目状态为"未开始"，目标金额>0
- **状态变更**：状态从"未开始"变为"进行中"

### 2.2 捐赠管理
#### 2.2.1 捐赠资金
- **功能描述**：用户向众筹项目捐赠资金
- **业务规则**：
  - 仅"进行中"状态可接受捐赠
  - 自动检查众筹是否过期
  - 超额捐赠自动退还多余金额
  - 记录每个捐赠者的捐赠金额
  - 达到目标金额自动标记为完成

#### 2.2.2 捐赠记录管理
- **功能描述**：维护捐赠者及其捐赠金额的映射
- **数据结构**：BTreeMap<Pubkey, u64>
- **用途**：用于后续按比例退款计算

### 2.3 资金分配管理
#### 2.3.1 完成众筹
- **功能描述**：手动触发众筹完成
- **前置条件**：众筹已到期，状态为"进行中"
- **业务规则**：
  - 根据已筹金额判断成功或失败
  - 自动更新项目状态

#### 2.3.2 分配资金
- **功能描述**：执行资金分配逻辑
- **成功众筹**：
  - 将资金（扣除租金）转给项目所有者
- **失败众筹**：
  - 按捐赠比例退还资金（扣除租金）
  - 精确计算每个捐赠者的退款金额

### 2.4 账户租金管理
#### 2.4.1 租金免除机制
- **功能描述**：确保账户有足够租金免除余额
- **实现方式**：
  - 创建时自动存入最小租金
  - 资金分配时保留租金金额
  - 使用`Rent::get()?.minimum_balance()`动态计算

#### 2.4.2 账户关闭
- **功能描述**：关闭众筹账户并退还租金
- **前置条件**：
  - 项目状态为"已完成"或"已失败"
  - 账户中无剩余可分配资金
- **业务规则**：退还租金给项目所有者

### 2.5 进度更新功能
#### 2.5.1 添加进度更新
- **功能描述**：项目所有者发布项目进展
- **输入参数**：更新内容（最大1024字符）
- **记录信息**：时间戳、更新内容

## 3. 非功能需求

### 3.1 性能要求
- **交易处理**：支持高并发捐赠操作
- **存储优化**：使用BTreeMap高效管理捐赠记录
- **计算效率**：优化的退款算法，避免精度损失

### 3.2 安全性要求
- **权限控制**：
  - 关键操作仅限项目所有者
  - 状态转换的严格验证
- **资金安全**：
  - 防止重复支付
  - 防止资金锁定
  - 安全的退款机制

### 3.3 可用性要求
- **错误处理**：清晰的错误信息和错误代码
- **输入验证**：严格的参数长度和格式检查
- **状态管理**：明确的状态转换规则

### 3.4 成本优化
- **存储成本**：合理的账户空间分配
- **交易成本**：优化的指令设计减少gas消耗
- **租金管理**：主动的租金退还机制

## 4. 技术架构

### 4.1 系统架构
```
用户界面 (前端)
    ↓
Solana区块链网络
    ↓
众筹智能合约
    ├── 项目管理模块
    ├── 捐赠管理模块
    ├── 资金分配模块
    └── 账户管理模块
```

### 4.2 数据模型

#### 4.2.1 Funding账户结构
```rust
pub struct Funding {
    // 基本信息
    name: String,           // 项目名称
    description: String,    // 项目描述
    category: String,       // 项目分类
    tags: Vec<String>,      // 项目标签
    
    // 财务信息
    goal: u64,              // 目标金额
    raised: u64,            // 已筹金额
    end_time: i64,          // 结束时间
    
    // 状态信息
    status: FundingStatus,  // 项目状态
    owner: Pubkey,          // 所有者
    
    // 动态信息
    updates: Vec<FundingUpdate>,    // 进度更新
    donations: BTreeMap<Pubkey, u64>, // 捐赠记录
}
```

#### 4.2.2 状态枚举
```rust
pub enum FundingStatus {
    NotStarted,     // 未开始
    Ongoing,        // 进行中
    Completed,      // 已完成（成功）
    Failed,         // 已失败
    Closed,         // 已关闭
}
```

### 4.3 核心算法

#### 4.3.1 超额捐赠处理算法
```
输入：捐赠金额amount，目标金额goal，已筹金额raised
输出：实际捐赠金额actual_donation，退款金额refund_amount

1. 计算剩余需要金额：remaining = goal - raised
2. 如果amount <= remaining：
   - actual_donation = amount
   - refund_amount = 0
3. 否则：
   - actual_donation = remaining
   - refund_amount = amount - remaining
4. 返回(actual_donation, refund_amount)
```

#### 4.3.2 按比例退款算法
```
输入：总退款金额total_refund，捐赠记录donations
输出：每个捐赠者的退款金额

1. 计算总捐赠金额：total_donated = sum(donations.values)
2. 对于每个捐赠者(donor, amount)：
   - 退款比例 = amount / total_donated
   - 退款金额 = total_refund × 退款比例
3. 执行退款转账
```

## 5. 业务规则

### 5.1 状态转换规则
```
未开始 → 进行中：调用start_funding
进行中 → 已完成：达到目标金额或手动完成
进行中 → 已失败：超过结束时间未达目标
已完成 → 已关闭：资金分配后关闭账户
已失败 → 已关闭：退款完成后关闭账户
```

### 5.2 权限规则
- 创建项目：任何用户
- 更新项目：仅项目所有者，且状态为未开始
- 开始众筹：仅项目所有者，且状态为未开始
- 添加更新：仅项目所有者
- 完成众筹：仅项目所有者，且已到期
- 分配资金：仅项目所有者，且状态为已完成或已失败
- 关闭账户：仅项目所有者，且状态为已完成或已失败

### 5.3 资金规则
- 最小捐赠金额：无限制（由前端控制）
- 超额捐赠：自动退还多余部分
- 资金分配：成功转给所有者，失败按比例退款
- 租金管理：始终保留租金免除金额

## 6. 错误处理

### 6.1 错误类型
```rust
pub enum CrowdfundingError {
    FundingNotEditable,     // 项目不可编辑
    FundingNotOngoing,      // 项目不在进行中
    FundingAlreadyCompleted, // 项目已完成
    FundingNotEnded,        // 项目未结束
    FundingGoalNotReached,  // 目标未达成
    InsufficientFunds,      // 资金不足
    InvalidStateTransition, // 无效状态转换
    Unauthorized,           // 未授权操作
    DonationExceedsGoal,    // 捐赠超额
    CategoryTooLong,        // 分类过长
    TagTooLong,             // 标签过长
    UpdateTooLong,          // 更新内容过长
    CannotCloseWithFunds,   // 有资金时不可关闭
    AccountNotClosable,     // 账户不可关闭
}
```

## 7. 部署和运维

### 7.1 部署策略
- **网络选择**：优先部署到Solana devnet进行测试
- **程序ID**：`52G2LBSFR2LE2wfdKotPdvN8jVgJ8SKRUKZntAQUwJcE`
- **升级机制**：通过Anchor框架的程序升级功能

### 7.2 监控指标
- 活跃项目数量
- 成功众筹比例
- 平均筹资时间
- 用户捐赠行为分析

## 8. 风险评估和缓解

### 8.1 技术风险
- **智能合约漏洞**：通过全面测试和审计缓解
- **区块链网络拥堵**：优化gas使用，设置合理超时

### 8.2 业务风险
- **恶意项目**：前端实施项目审核机制
- **资金锁定**：明确的关闭和退款流程

## 9. 未来扩展

### 9.1 功能扩展
- 多币种支持
- 分阶段众筹
- 项目评论和评级系统
- 自动延期机制

### 9.2 技术优化
- 捐赠者通知系统
- 数据分析仪表板
- 移动端优化
- 跨链桥接支持

## 10. 结论

本众筹智能合约提供了一个完整、安全、高效的众筹解决方案，通过合理的架构设计和业务规则，确保了平台的可靠性和用户体验。随着区块链技术的普及，此类去中心化众筹平台将在未来发挥越来越重要的作用。